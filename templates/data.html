{% extends "base.html" %}

{% block title %}æ•°æ®ç®¡ç† - å½©ç¥¨åˆ†æé¢„æµ‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ’¾ æ•°æ®ç®¡ç†</h1>
    <p>å¯¼å…¥ã€å¯¼å‡ºå’Œç®¡ç†å½©ç¥¨æ•°æ®</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>ç”Ÿæˆæ•°æ®</h2>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label>æ•°æ®æ¡æ•°:</label>
            <input type="number" id="numDraws" class="form-control" value="100" min="10" max="1000">
        </div>
        <button id="generateBtn" class="btn btn-primary">ç”Ÿæˆæ ·æœ¬æ•°æ®</button>
        <span id="generateStatus" class="status-text"></span>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>å¯¼å…¥æ•°æ®</h2>
    </div>
    <div class="card-body">
        <p>æ”¯æŒCSVã€JSONå’ŒExcelæ ¼å¼</p>
        <input type="file" id="fileInput" class="form-control" accept=".csv,.json,.xlsx,.xls">
        <button id="importBtn" class="btn btn-success">å¯¼å…¥æ–‡ä»¶</button>
        <span id="importStatus" class="status-text"></span>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>æ•°æ®ä¿¡æ¯</h2>
    </div>
    <div class="card-body">
        <div id="dataInfo" class="info-text">æš‚æ— æ•°æ®</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('generateBtn').addEventListener('click', async function() {
    this.disabled = true;
    this.textContent = 'ç”Ÿæˆä¸­...';
    
    const numDraws = parseInt(document.getElementById('numDraws').value);
    
    try {
        const response = await fetch('/api/generate-sample-data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({num_draws: numDraws})
        });
        
        const data = await response.json();
        const statusEl = document.getElementById('generateStatus');
        
        if (data.success) {
            statusEl.textContent = `âœ“ å·²ç”Ÿæˆ ${data.count} æ¡æ•°æ®`;
            statusEl.className = 'status-text success';
            updateDataInfo(data.count, data.data);
        } else {
            statusEl.textContent = `âœ— ç”Ÿæˆå¤±è´¥: ${data.error}`;
            statusEl.className = 'status-text error';
        }
    } catch (error) {
        alert('é”™è¯¯: ' + error.message);
    } finally {
        this.disabled = false;
        this.textContent = 'ç”Ÿæˆæ ·æœ¬æ•°æ®';
    }
});

document.getElementById('importBtn').addEventListener('click', async function() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    this.disabled = true;
    this.textContent = 'å¯¼å…¥ä¸­...';
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/import-data', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        const statusEl = document.getElementById('importStatus');
        
        if (data.success) {
            statusEl.textContent = `âœ“ å·²å¯¼å…¥ ${data.count} æ¡æ•°æ®`;
            statusEl.className = 'status-text success';
            updateDataInfo(data.count, data.data);
        } else {
            statusEl.textContent = `âœ— å¯¼å…¥å¤±è´¥: ${data.error}`;
            statusEl.className = 'status-text error';
        }
    } catch (error) {
        alert('é”™è¯¯: ' + error.message);
    } finally {
        this.disabled = false;
        this.textContent = 'å¯¼å…¥æ–‡ä»¶';
    }
});

function updateDataInfo(count, sampleData) {
    const infoEl = document.getElementById('dataInfo');
    
    let html = `<p><strong>æ€»æ•°æ®é‡:</strong> ${count} æ¡</p>`;
    
    if (sampleData && sampleData.length > 0) {
        html += '<p><strong>æ•°æ®ç¤ºä¾‹ (å‰10æ¡):</strong></p>';
        html += '<div class="data-preview">';
        sampleData.forEach((draw, index) => {
            html += `<div class="draw-item">`;
            html += `<span class="draw-number">#${index + 1}</span>`;
            html += `<span class="draw-numbers">[${draw.join(', ')}]</span>`;
            html += `</div>`;
        });
        html += '</div>';
    }
    
    infoEl.innerHTML = html;
}
</script>
{% endblock %}
