{% extends "base.html" %}

{% block title %}å®ç”¨å·¥å…· - å½©ç¥¨åˆ†æé¢„æµ‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ› ï¸ å®ç”¨å·¥å…·</h1>
    <p>å¯†ç ç”Ÿæˆå™¨å’Œè®°å½•ç®¡ç†</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>å¯†ç ç”Ÿæˆå™¨</h2>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label>å¯†ç é•¿åº¦:</label>
            <input type="number" id="passwordLength" class="form-control" value="16" min="8" max="32">
        </div>
        
        <div class="checkbox-group">
            <label><input type="checkbox" id="useUppercase" checked> å¤§å†™å­—æ¯ (A-Z)</label>
            <label><input type="checkbox" id="useLowercase" checked> å°å†™å­—æ¯ (a-z)</label>
            <label><input type="checkbox" id="useDigits" checked> æ•°å­— (0-9)</label>
            <label><input type="checkbox" id="useSpecial" checked> ç‰¹æ®Šå­—ç¬¦ (!@#$...)</label>
        </div>
        
        <button id="generatePasswordBtn" class="btn btn-primary">ç”Ÿæˆå¯†ç </button>
        
        <div id="passwordResult" class="password-result"></div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>é¢„æµ‹è®°å½•</h2>
    </div>
    <div class="card-body">
        <button id="loadRecordsBtn" class="btn btn-secondary">åŠ è½½è®°å½•</button>
        
        <div id="recordsList" class="records-list"></div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>æ·»åŠ æ–°è®°å½•</h2>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label>æ ‡é¢˜:</label>
            <input type="text" id="recordTitle" class="form-control" placeholder="ä¾‹å¦‚: 2024-01-15é¢„æµ‹">
        </div>
        
        <div class="form-group">
            <label>å·ç  (ç”¨é€—å·åˆ†éš”):</label>
            <input type="text" id="recordNumbers" class="form-control" placeholder="ä¾‹å¦‚: 1,5,12,23,34,45">
        </div>
        
        <div class="form-group">
            <label>å¤‡æ³¨:</label>
            <textarea id="recordNotes" class="form-control" rows="3" placeholder="å¯é€‰å¤‡æ³¨ä¿¡æ¯"></textarea>
        </div>
        
        <button id="addRecordBtn" class="btn btn-success">æ·»åŠ è®°å½•</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('generatePasswordBtn').addEventListener('click', async function() {
    const length = parseInt(document.getElementById('passwordLength').value);
    const useUppercase = document.getElementById('useUppercase').checked;
    const useLowercase = document.getElementById('useLowercase').checked;
    const useDigits = document.getElementById('useDigits').checked;
    const useSpecial = document.getElementById('useSpecial').checked;
    
    try {
        const response = await fetch('/api/generate-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                length: length,
                use_uppercase: useUppercase,
                use_lowercase: useLowercase,
                use_digits: useDigits,
                use_special: useSpecial
            })
        });
        
        const data = await response.json();
        if (data.success) {
            const resultEl = document.getElementById('passwordResult');
            resultEl.innerHTML = `<div class="password-display">
                <input type="text" value="${data.password}" readonly class="password-text">
                <button onclick="copyPassword('${data.password}')" class="btn btn-small">å¤åˆ¶</button>
            </div>`;
        } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('é”™è¯¯: ' + error.message);
    }
});

function copyPassword(password) {
    navigator.clipboard.writeText(password).then(() => {
        alert('å¯†ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
}

document.getElementById('loadRecordsBtn').addEventListener('click', async function() {
    try {
        const response = await fetch('/api/records');
        const data = await response.json();
        
        if (data.success) {
            displayRecords(data.records);
        } else {
            alert('åŠ è½½å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('é”™è¯¯: ' + error.message);
    }
});

function displayRecords(records) {
    const container = document.getElementById('recordsList');
    
    if (records.length === 0) {
        container.innerHTML = '<p class="empty-message">æš‚æ— è®°å½•</p>';
        return;
    }
    
    let html = '<div class="records-container">';
    records.forEach(record => {
        html += `<div class="record-item">
            <div class="record-header">
                <h4>${record.title}</h4>
                <button onclick="deleteRecord('${record.id}')" class="btn btn-danger btn-small">åˆ é™¤</button>
            </div>
            <div class="record-body">
                <p><strong>å·ç :</strong> ${record.numbers.join(', ')}</p>
                ${record.notes ? `<p><strong>å¤‡æ³¨:</strong> ${record.notes}</p>` : ''}
                <p class="record-date">${record.timestamp}</p>
            </div>
        </div>`;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

async function deleteRecord(recordId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/records/${recordId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            alert('åˆ é™¤æˆåŠŸ');
            document.getElementById('loadRecordsBtn').click();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('é”™è¯¯: ' + error.message);
    }
}

document.getElementById('addRecordBtn').addEventListener('click', async function() {
    const title = document.getElementById('recordTitle').value;
    const numbersStr = document.getElementById('recordNumbers').value;
    const notes = document.getElementById('recordNotes').value;
    
    if (!title || !numbersStr) {
        alert('è¯·å¡«å†™æ ‡é¢˜å’Œå·ç ');
        return;
    }
    
    const numbers = numbersStr.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
    
    if (numbers.length === 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å·ç ');
        return;
    }
    
    try {
        const response = await fetch('/api/records', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: title,
                numbers: numbers,
                notes: notes
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('æ·»åŠ æˆåŠŸ');
            document.getElementById('recordTitle').value = '';
            document.getElementById('recordNumbers').value = '';
            document.getElementById('recordNotes').value = '';
            document.getElementById('loadRecordsBtn').click();
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + data.error);
        }
    } catch (error) {
        alert('é”™è¯¯: ' + error.message);
    }
});
</script>
{% endblock %}
